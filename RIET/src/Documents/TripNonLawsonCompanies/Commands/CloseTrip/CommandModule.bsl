
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	// { RGS AArsentev 20.09.2017 S-I-0003596
	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрКоманды, "Secondary") Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Trip может быть закрыт только через закрытие - " + ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрКоманды, "Primary"));
		Возврат
	КонецЕсли;
	// } RGS AArsentev 20.09.2017 S-I-0003596
	
	SQ_Fields = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрКоманды, "OnTime, OutOfComplianceReason, OOC_Responsible");
	
	Если SQ_Fields.OnTime <> ПредопределенноеЗначение("Перечисление.YesNo.Yes") Тогда
		
		НужноЗаполнить_SQ_Fields = Ложь;
		
		Если НЕ ЗначениеЗаполнено(SQ_Fields.OutOfComplianceReason) ИЛИ НЕ ЗначениеЗаполнено(SQ_Fields.OOC_Responsible) Тогда
			Оповестить("НужноЗаполнить_SQ_Fields", , ПараметрКоманды);
			Возврат;
		КонецЕсли;
				
	КонецЕсли;
		
	Stage = ОпределитьStage(ПараметрКоманды);
	
	Если Stage = ПредопределенноеЗначение("Перечисление.TripNonLawsonCompaniesStages.Saved_ApprovalIsNotRequired")
		ИЛИ Stage = ПредопределенноеЗначение("Перечисление.TripNonLawsonCompaniesStages.Approved") Тогда
		
		// { RGS ASeryakov 21.07.18 S-I-0005597
		// В процедуре CloseTrip где выполняется уже проверка заполнения WaybillNo это сделать нельзя,
		// поскольку она выполняется на сервере и не будет работать механизм оповещений и подсвечивание незаполненного поля.
		
		Waybill_Field = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрКоманды, "MOT, WaybillNo, ServiceProvider");
		
		Если Waybill_Field.MOT = ПредопределенноеЗначение("Справочник.MOTs.COURIER") И ЭтоServiceProvidersDHLНаСервере(Waybill_Field.ServiceProvider) Тогда
			
			Если НЕ ЗначениеЗаполнено(Waybill_Field.WaybillNo) Тогда
				
				Оповестить("СообщитьЗаполнитьWaybillNo", ,ПараметрКоманды);
				Возврат;
			ИначеЕсли ЗначениеЗаполнено(Waybill_Field.WaybillNo)И СтрДлина(СокрЛП(Waybill_Field.WaybillNo)) < 10 Тогда
				
				Оповестить("СообщитьЗаполнитьКоличествоWaybillNo", ,ПараметрКоманды);
				Возврат;
				
			КонецЕсли;
			
		КонецЕсли;
		// } RGS ASeryakov 21.07.18 S-I-0005597

		
		CloseTrip(ПараметрКоманды);

		Оповестить("ЗаписанApproval", , ПараметрКоманды);
		ОповеститьОбИзменении(ПараметрКоманды);
		
	иначе
		
		Если РГСофтСерверПовтИспСеанс.ПолучитьПараметрСеансаShowNamesAndDescriptionsRUS()  Тогда 
			Сообщить("Текущий статус поставки: '"+ СокрЛП(Stage) +"'. 
			|Поставка не может быть закрыта!");
		Иначе 
			Сообщить("Current trip stage: '"+ СокрЛП(Stage) +"'. 
			|Trip can not be closed!");
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ОпределитьStage(Trip)
	
	Возврат РегистрыСведений.StagesOfTripsNonLawsonCompanies.ОпределитьStage(Trip);	
	
КонецФункции
	
&НаСервере
Процедура CloseTrip(TripСсылка)
	
	УстановитьПривилегированныйРежим(Истина);
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(TripСсылка, "DateOfBorderCrossing, WaybillNo, WaybillDate");
	//{ RGS AArsentev 08.08.2017 S-I-0003521
	ЭтоПеревозкаПоТаможенномуСоюзу = ПроверитьТаможенныйСоюз(TripСсылка);
	Если ЭтоПеревозкаПоТаможенномуСоюзу Тогда
		ЕстьОшибкиЗаполнения = Ложь;
		ТекстОшибкиЗаполнения = "Поставка по таможенному союзу, для закрытия необходимо заполнить следующие поля: ";
		Если Не ЗначениеЗаполнено(ЗначенияРеквизитов.DateOfBorderCrossing) Тогда
			ТекстОшибкиЗаполнения = ТекстОшибкиЗаполнения + "Date of border crossing";
			ЕстьОшибкиЗаполнения = Истина;
		КонецЕсли;
		//// { RGS ASeryakov 21.07.18 S-I-0005597
		//Если Не ЗначениеЗаполнено(ЗначенияРеквизитов.WaybillNo) Тогда
		//	Если ЕстьОшибкиЗаполнения Тогда
		//		ТекстОшибкиЗаполнения = ТекстОшибкиЗаполнения + ", Waybill no";
		//	Иначе
		//		ТекстОшибкиЗаполнения  = ТекстОшибкиЗаполнения + "Waybill no";
		//	КонецЕсли;
		//	ЕстьОшибкиЗаполнения = Истина;
		//КонецЕсли;
		//// } RGS ASeryakov 21.07.18 S-I-0005597
		Если Не ЗначениеЗаполнено(ЗначенияРеквизитов.WaybillDate) Тогда
			Если ЕстьОшибкиЗаполнения Тогда 
				ТекстОшибкиЗаполнения = ТекстОшибкиЗаполнения + ", Waybill date";
			Иначе
				ТекстОшибкиЗаполнения = ТекстОшибкиЗаполнения + "Waybill date";
			КонецЕсли;
			ЕстьОшибкиЗаполнения = Истина;
		КонецЕсли;
		ТекстОшибкиЗаполнения = ТекстОшибкиЗаполнения + ".";
		Если ЕстьОшибкиЗаполнения Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ТекстОшибкиЗаполнения;
			Сообщение.Сообщить();
			Возврат;
		КонецЕсли;
	КонецЕсли;
	//} RGS AArsentev 08.08.2017 S-I-0003521	
	TripОбъект = TripСсылка.ПолучитьОбъект();
	TripОбъект.Closed = ТекущаяДата();
	// { RGS Aseryakov 03.09.2017 S-I-0003797
	TripОбъект.ClosedBy = ПараметрыСеанса.ТекущийПользователь;
	// { RGS Aseryakov 03.09.2017 S-I-0003797
	TripОбъект.Записать();
	
	// { RGS AArsentev 20.09.2017 S-I-0003596
	ВыборкаSecondary = Документы.TripNonLawsonCompanies.ПолучитьSecondaryTrips(TripСсылка);
	Пока ВыборкаSecondary.Следующий() Цикл
		SecondaryTrip = ВыборкаSecondary.Ссылка.ПолучитьОбъект();
		SecondaryTrip.Closed = ТекущаяДата();
		SecondaryTrip.Записать();
	КонецЦикла;
	// } RGS AArsentev 20.09.2017 S-I-0003596
	
	УстановитьПривилегированныйРежим(Ложь);

КонецПроцедуры

//{ RGS AArsentev 08.08.2017 S-I-0003521
&НаСервере
Функция ПроверитьТаможенныйСоюз(Trip)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	TripNonLawsonCompaniesParcels.Parcel.TransportRequest КАК Ссылка
	|ИЗ
	|	Документ.TripNonLawsonCompanies.Parcels КАК TripNonLawsonCompaniesParcels
	|ГДЕ
	|	TripNonLawsonCompaniesParcels.Ссылка = &Trip
	|	И TripNonLawsonCompaniesParcels.Parcel.TransportRequest.CustomUnionTransaction";
	Запрос.УстановитьПараметр("Trip", Trip);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;	
	
КонецФункции //} RGS AArsentev 08.08.2017 S-I-0003521

// { RGS ASeryakov 21.07.18 S-I-0005597
&НаСервере
Функция ЭтоServiceProvidersDHLНаСервере(ServiceProvider)

	Возврат Документы.TripNonLawsonCompanies.ЭтоServiceProvidersDHL(ServiceProvider);

КонецФункции // ЭтоServiceProvidersDHLНаСервере()
// } RGS ASeryakov 21.07.18 S-I-000559