
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	// { RGS AArsentev 20.09.2017 S-I-0003596
	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрКоманды, "Secondary") Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Trip может быть возвращен в работу только с - " + ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрКоманды, "Primary"));
		Возврат
	КонецЕсли;
	// } RGS AArsentev 20.09.2017 S-I-0003596
	
	Stage = ОпределитьStage(ПараметрКоманды);
	
	Если Stage = ПредопределенноеЗначение("Перечисление.TripNonLawsonCompaniesStages.Closed") Тогда
		
		ReturnToWorkTrip(ПараметрКоманды);
		
		Оповестить("ЗаписанApproval", , ПараметрКоманды);
		ОповеститьОбИзменении(ПараметрКоманды);

	иначе
		
		Сообщить("Trip is not closed / Поставка не закрыта!");
		
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ОпределитьStage(Trip)
	
	Возврат РегистрыСведений.StagesOfTripsNonLawsonCompanies.ОпределитьStage(Trip);	
	
КонецФункции
	
&НаСервере
Процедура ReturnToWorkTrip(TripСсылка)
	// { RGS AArsentev 27.07.2016 11:20:41 S-I-0001749
	Доступен_ВозвратВРаботу = Истина;
	Доступен_ВозвратВРаботу = ПроверитьНаЗатраты(TripСсылка);
	Если TripСсылка.VerifiedByBillingSpecialist <> Дата("01.01.0001 00:00:00") тогда
		Доступен_ВозвратВРаботу = ПроверитьВозможностьВозврата(TripСсылка)
	КонецЕсли;
	// } RGS AArsentev 27.07.2016 11:20:41 S-I-0001749
	Если Доступен_ВозвратВРаботу тогда
		УстановитьПривилегированныйРежим(Истина);
		
		НачатьТранзакцию(РежимУправленияБлокировкойДанных.Управляемый);
		
		TripОбъект = TripСсылка.ПолучитьОбъект();
		TripОбъект.ОбменДанными.Загрузка = Истина;
		TripОбъект.Closed = Неопределено;
		TripОбъект.VerifiedByBillingSpecialist = Неопределено;
		TripОбъект.BillingSpecialist = Неопределено;
		TripОбъект.Записать();
		
		NewStage = РегистрыСведений.StagesOfTripsNonLawsonCompanies.ПолучитьTripStage(TripСсылка);
		
		МенеджерЗаписи = РегистрыСведений.StagesOfTripsNonLawsonCompanies.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Trip = TripСсылка;
		МенеджерЗаписи.Stage = NewStage;                          
		МенеджерЗаписи.ModificationDate = ТекущаяДата();
		МенеджерЗаписи.Записать(Истина);
		
		// { RGS AArsentev 20.09.2017 S-I-0003596
		ВыборкаSecondary = Документы.TripNonLawsonCompanies.ПолучитьSecondaryTrips(TripСсылка);
		Пока ВыборкаSecondary.Следующий() Цикл
			
			SecondaryTrip = ВыборкаSecondary.Ссылка.ПолучитьОбъект();
			SecondaryTrip.ОбменДанными.Загрузка = Истина;
			SecondaryTrip.Closed = Неопределено;
			SecondaryTrip.VerifiedByBillingSpecialist = Неопределено;
			SecondaryTrip.BillingSpecialist = Неопределено;
			SecondaryTrip.Записать();
			
			МенеджерЗаписи = РегистрыСведений.StagesOfTripsNonLawsonCompanies.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.Trip = ВыборкаSecondary.Ссылка;
			МенеджерЗаписи.Stage = NewStage;
			МенеджерЗаписи.ModificationDate = ТекущаяДата();
			МенеджерЗаписи.Записать(Истина);
			
		КонецЦикла;
		// } RGS AArsentev 20.09.2017 S-I-0003596

		
		ЗафиксироватьТранзакцию();
		
		УстановитьПривилегированныйРежим(Ложь);
		
	Иначе
		
		Message = New UserMessage();
		Message.Text = "У Вас недостаточно прав для возврата документа в работу";
		Message.Message();
		
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ПроверитьВозможностьВозврата(TripСсылка)

		Если РольДоступна("LocalDistributionBillingSpecialist_ForNonLawsonCompanies") или РольДоступна("LocalDistributionAdministrator") Тогда
			Возврат Истина
		иначе
			Возврат Ложь
		КонецЕсли;

КонецФункции 
	
Функция ПроверитьНаЗатраты(TripСсылка)
	// { RGS AArsentev
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	RentalTrucksCostsSumsRentalTrucks.Ссылка
	|ИЗ
	|	Документ.RentalTrucksCostsSums.RentalTrucks КАК RentalTrucksCostsSumsRentalTrucks
	|ГДЕ
	|	RentalTrucksCostsSumsRentalTrucks.Trip = &Trip";
	Запрос.УстановитьПараметр("Trip", TripСсылка);
	Результат = Запрос.Выполнить().Выгрузить();
	Если Результат.Количество() <> 0 Тогда
		Сообщить("Нельзя вернуть трип в работу, т.к. затраты уже утверждены документом "+Результат[0].Ссылка);
		Возврат Ложь;
	Иначе 
		Возврат Истина;
	КонецЕсли;
	
КонецФункции  // } RGS AArsentev