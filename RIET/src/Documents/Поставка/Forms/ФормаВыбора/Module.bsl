
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("СтруктураНастройки") Тогда
		
		СтруктураНастройки = Параметры.СтруктураНастройки;
		Если СтруктураНастройки.Имя = "ВыборИзInvoiceLinesMatching" Тогда
			НастроитьДляВыбораИзInvoiceLinesMatching(СтруктураНастройки);
		КонецЕсли;
		
	КонецЕсли;
	
	Отбор = Параметры.Отбор;
	
	Отбор.Вставить("Отменен", Ложь);
	
	ImportExportСервер.ДобавитьОтборПоProcessLevelПриНеобходимости(Отбор, "ProcessLevel");
		
КонецПроцедуры

&НаСервере
Процедура НастроитьДляВыбораИзInvoiceLinesMatching(СтруктураНастройки)
		
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("CurrentInvoiceLinesMatching", СтруктураНастройки.CurrentInvoiceLinesMatching);
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Поставки.Ссылка
		|ИЗ
		|	Документ.Поставка КАК Поставки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗакрытиеПоставки КАК InvoiceLinesMatching
		|		ПО Поставки.Ссылка = InvoiceLinesMatching.Поставка
		|			И ((НЕ InvoiceLinesMatching.ПометкаУдаления))
		|			И ((НЕ InvoiceLinesMatching.Ссылка = &CurrentInvoiceLinesMatching))
		|ГДЕ
		|	(НЕ Поставки.Отменен)
		|	И (НЕ Поставки.Cleared = ДАТАВРЕМЯ(1, 1, 1))
		|	И InvoiceLinesMatching.Ссылка ЕСТЬ NULL ";
	Shipments = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	СтруктураОтбора = Параметры.Отбор;
	СтруктураОтбора.Вставить("Ссылка", Shipments);
	
КонецПроцедуры


