
&НаКлиенте
Процедура SiebelOrderПриИзменении(Элемент)
	УстановитьРучнуюКорректировку();
КонецПроцедуры

&НаКлиенте
Процедура УстановитьРучнуюКорректировку()
	Элементы.НаборЗаписей.ТекущиеДанные.РучнаяКорректировка = Истина;
КонецПроцедуры	

&НаКлиенте
Процедура РеализацияПриИзменении(Элемент)
	УстановитьРучнуюКорректировку();
КонецПроцедуры

&НаКлиенте
Процедура КоличествоSOПриИзменении(Элемент)
	УстановитьРучнуюКорректировку();
КонецПроцедуры

&НаКлиенте
Процедура КоличествоПриИзменении(Элемент)
	УстановитьРучнуюКорректировку();
КонецПроцедуры

&НаКлиенте
Процедура СебестоимостьПриИзменении(Элемент)
	УстановитьРучнуюКорректировку();
КонецПроцедуры

&НаКлиенте
Процедура НаборЗаписейПриАктивизацииСтроки(Элемент)
	ТД = Элементы.НаборЗаписей.ТекущиеДанные;
	Если ТД <> Неопределено Тогда
		ТЧСписания.Параметры.УстановитьЗначениеПараметра("Списание",ТД.Регистратор);
		ТЧСиблОрдера.Параметры.УстановитьЗначениеПараметра("Ссылка", ТД.SiebelOrder);
		Элементы.ТЧСиблОрдера.Обновить();
		Элементы.ТЧСписания.Обновить();
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура Сопоставить(Команда)
	Если Элементы.ТЧСиблОрдера.ТекущиеДанные = Неопределено ИЛИ Элементы.ТЧСписания.ТекущиеДанные = Неопределено Тогда
		Сообщить("Выберите строки");
		Возврат;
	КонецЕсли;
	СиблОрдер = Элементы.ТЧСиблОрдера.ТекущиеДанные;
	Товар = Элементы.ТЧСписания.ТекущиеДанные.Good;
	Отбор = Новый Структура("Good", Товар);
	СтрокиПоТовару = НаборЗаписей.НайтиСтроки(Отбор);
	CF = Справочники.UOMs.НайтиПоКоду("CF ");
	LB = Справочники.UOMs.НайтиПоКоду("LB ");
	GA = Справочники.UOMs.НайтиПоКоду("GA ");
	Для Каждого Стр Из СтрокиПоТовару Цикл
		Стр.DescriptionSO = СиблОрдер.Description;
		Стр.PartNumberSO = СиблОрдер.PartNumber;
		Стр.КоличествоSO = СиблОрдер.Количество;
		Стр.ЕдиницаИзмеренияSO = Справочники.UOMs.НайтиПоКоду(СиблОрдер.ЕдиницаИзмерения);
		СТр.СуммаSO = СиблОрдер.Сумма;
		Стр.Account = СиблОрдер.Account;
		Стр.ParentLineID = СиблОрдер.ParentLineID;	
		Количество = Стр.Количество;	
		КоличествоSO = Стр.КоличествоSO;
		Если ЗначениеЗаполнено(Стр.ЕдиницаИзмеренияSO) И Стр.ЕдиницаИзмеренияSO <> Стр.ЕдиницаИзмерения Тогда
			Если Стр.ЕдиницаИзмерения.StandardUOM = Стр.ЕдиницаИзмеренияSO Тогда
				Количество = Стр.Количество * Стр.ЕдиницаИзмерения.ConversionFactor;
			ИначеЕсли Стр.ЕдиницаИзмерения.StandardUOM = Стр.ЕдиницаИзмеренияSO.StandardUOM Тогда
				Количество = Стр.Количество * Стр.ЕдиницаИзмерения.ConversionFactor;	
				КоличествоSO = Стр.КоличествоSO * Стр.ЕдиницаИзмеренияSO.ConversionFactor;
			КонецЕсли;
			
			
		ИначеЕсли Стр.ЕдиницаИзмеренияSO = "T" Тогда
			
			Если Стр.ЕдиницаИзмерения = CF ИЛИ Стр.ЕдиницаИзмерения = LB Тогда
				Количество = Стр.Количество * Стр.ЕдиницаИзмерения.ConversionFactor;
				КоличествоSO = Стр.КоличествоSO * 1000;
			ИначеЕсли Стр.ЕдиницаИзмерения = GA Тогда
				Количество = Стр.Количество;
				КоличествоSO = Стр.КоличествоSO * 326.9494;
				
			КонецЕсли;	
			
		КонецЕсли;
		КоличествоSO = ?(КоличествоSO = Неопределено, Стр.КоличествоSO, КоличествоSO);
		Разница = Количество - КоличествоSO;
		ПроцентРасхождения = КоличествоSO / 100 * 1.5;
		Если  Разница>-ПроцентРасхождения И Разница<ПроцентРасхождения Тогда
			Количество = КоличествоSO;
		КонецЕсли;
		Стр.Себестоимость = ?(КоличествоSO = 0, 0, Стр.СуммаСписания  / Количество * КоличествоSO);
		Стр.РучнаяКорректировка = Истина;
	КонецЦикла;	
	
	
КонецПроцедуры
