
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("Заявка", Заявка);
	Параметры.Свойство("УзелОбмена", УзелОбмена);
	ОбновитьСписокПрисоединенныхФайловНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСписокПрисоединенныхФайлов(Команда)
	
	ОбновитьСписокПрисоединенныхФайловНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСписокПрисоединенныхФайловНаСервере()
	
	ТаблицаПрисоединенныеФайлы.Очистить();
	
	WSСсылка = WSСсылки.rgsИнтеграцияСERM;
	ФабрикаXDTOERM = WSСсылка.ПолучитьWSОпределения().ФабрикаXDTO;
	WSПрокси = Обработки.rgsИнтеграцияСERM.СоздатьWSПрокси(УзелОбмена, WSСсылка);
	
	Попытка
		СтруктураВозвратаСпискаПрисоединенныхФайлов = WSПрокси.GetRequestAttachedFiles(Заявка);
	Исключение
		ТекстОшибки = ОписаниеОшибки();
		//ОбработатьТекстОшибки(ТекстОшибки);
		Возврат;
	КонецПопытки;
	
	Попытка
		СтруктураВозвратаСпискаПрисоединенныхФайлов.Проверить();
	Исключение
		ТекстОшибки = ОписаниеОшибки();
		//ОбработатьТекстОшибки(ТекстОшибки);
		Возврат;
	КонецПопытки;
	
	СписокПрисоединенныхФайловXDTO = СтруктураВозвратаСпискаПрисоединенныхФайлов.СписокПрисоединенныхФайлов.ПрисоединенныеФайлы;
	
	Для каждого ТекСтруктураПрисоединенногоФайла Из СписокПрисоединенныхФайловXDTO Цикл
		
		НоваяСтрокаПрисоединенногоФайла = ТаблицаПрисоединенныеФайлы.Добавить();
		НоваяСтрокаПрисоединенногоФайла.Наименование = ТекСтруктураПрисоединенногоФайла.Наименование;
		НоваяСтрокаПрисоединенногоФайла.Расширение = ТекСтруктураПрисоединенногоФайла.Расширение;
		НоваяСтрокаПрисоединенногоФайла.АдресДанныхФайла = ПоместитьВоВременноеХранилище(ТекСтруктураПрисоединенногоФайла.ФайлХранилище, УникальныйИдентификатор);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФайлДляПросмотра(Команда)
	
	ТекущиеДанные = Элементы.ТаблицаПрисоединенныеФайлы.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ИмяФайла = КаталогВременныхФайлов() + ТекущиеДанные.Наименование + "." + ТекущиеДанные.Расширение;
	
	ПолучитьФайл(ТекущиеДанные.АдресДанныхФайла, ИмяФайла, Истина);
	
КонецПроцедуры
