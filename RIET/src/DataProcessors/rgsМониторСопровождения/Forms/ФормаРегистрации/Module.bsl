&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Параметры.Свойство("ПредставлениеМонитора",ПредставлениеМонитора); 
	Параметры.Свойство("АдресБазы",Объект.АдресБазы);
	ПолучитьНастройкиФормы();
КонецПроцедуры

&НаСервере
Процедура ПолучитьНастройкиФормы()

	СтруктураНастроекФормы = ХранилищеНастроекДанныхФорм.Загрузить(ЭтаФорма.ИмяФормы, "НастройкаФорм");
	Если СтруктураНастроекФормы <> Неопределено Тогда
	   ХранилищеСистемныхНастроек.Сохранить(ЭтаФорма.ИмяФормы + "/НастройкиФормы",,СтруктураНастроекФормы);
	КонецЕсли;
	СтруктураНастроекОкна = ХранилищеНастроекДанныхФорм.Загрузить(ЭтаФорма.ИмяФормы, "НастройкаОкна");
	Если СтруктураНастроекФормы <> Неопределено Тогда
	   ХранилищеСистемныхНастроек.Сохранить(ЭтаФорма.ИмяФормы + "/НастройкиОкна",,СтруктураНастроекОкна);
	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УстановитьВидимостьДоступность();
КонецПроцедуры

&НаКлиенте
Процедура УстановитьВидимостьДоступность()
		
	

КонецПроцедуры

&НаКлиенте
Процедура ПолучитьКодПодтверждения(Команда)
	Если ПроверитьЗаполнениеРеквизитов("КодПодтверждения") Тогда
	   ПолучитьКодПодтвержденияНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПолучитьКодПодтвержденияНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	КлючЗащиты = ОбработкаОбъект.ПолучитьКлючЗащиты();
	Успех = Истина;
	Попытка
		Прокси  = ПолучитьПроксиСервисаРегистрации();
		ОписаниеОшибки = Прокси.PasswordRequest(Email,ПредставлениеМонитора,КлючЗащиты);
		Если ОписаниеОшибки<>"" Тогда
			Успех = Ложь;
			Сообщить(ОписаниеОшибки);
		КонецЕсли;
	Исключение
		Успех = Ложь;
		Сообщить(ОписаниеОшибки());
	КонецПопытки;	
	
	Если Успех Тогда
		Сообщить("На указанный Email отправлено письмо с кодом подтверждения регистрации.");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПолучитьПроксиСервисаРегистрации()
	Определение = Новый WSОпределения(Объект.АдресБазы+"_rs/ws/UserRegistration?wsdl");
	Прокси =  Новый WSПрокси (Определение, "UserRegistration", "UserRegistration", "UserRegistrationSoap");
	Возврат  Прокси;
КонецФункции // ()

&НаКлиенте
Процедура Регистрация(Команда)
	Если ПроверитьЗаполнениеРеквизитов("Регистрация") Тогда
		 РегистрацияСервер();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура РегистрацияСервер()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	КлючЗащиты = ОбработкаОбъект.ПолучитьКлючЗащиты();
	РегстрацияУспешна = Истина;
	Попытка
		Прокси  = ПолучитьПроксиСервисаРегистрации();
		ОписаниеОшибки = Прокси.Register(Email,КлючЗащиты,Пользователь,Пароль,СокрЛП(КодПодтверждения));
		Если ОписаниеОшибки<>"" Тогда
			РегстрацияУспешна = Ложь;
			Сообщить(ОписаниеОшибки);
		КонецЕсли;
	Исключение
		РегстрацияУспешна = Ложь;
	    Сообщить(ОписаниеОшибки());
	КонецПопытки;
	Элементы.ПодключитьсяНовымПользователем.Доступность = РегстрацияУспешна;
	Если РегстрацияУспешна Тогда
		Сообщить("Новый пользователь был успешно создан.");
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Функция ПроверитьЗаполнениеРеквизитов(Режим)
	Результат = Истина;
	Если Режим = "КодПодтверждения" Тогда
		Если НЕ ЗначениеЗаполнено(Email) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "Email";
			Сообщение.Текст = "Не заполнен Email!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;    
		
	ИначеЕсли Режим = "Регистрация" Тогда
		Если НЕ ЗначениеЗаполнено(Email) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "Email";
			Сообщение.Текст = "Не заполнен Email!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Пользователь) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "Пользователь";
			Сообщение.Текст = "Не заполнен пользователь!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли; 
		Если НЕ ЗначениеЗаполнено(Пароль) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "Пароль";
			Сообщение.Текст = "Не заполнен пароль";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(ПодтверждениеПароля) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "ПодтверждениеПароля";
			Сообщение.Текст = "Не заполнено подтверждение пароля!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;
		Если Пароль<>ПодтверждениеПароля Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "ПодтверждениеПароля";
			Сообщение.Текст = "Различаются пароль и подтверждения пароля!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(КодПодтверждения) Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Поле = "КодПодтверждения";
			Сообщение.Текст = "Не заполнен код подтверждения!";
			Сообщение.Сообщить();
			Результат = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
КонецФункции


&НаКлиенте
Процедура ПодключитьсяНовымПользователем(Команда)
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Пользователь",Пользователь);
	СтруктураВозврата.Вставить("Пароль", Пароль);
	Оповестить("ПользовательПарольИзменены",СтруктураВозврата, ЭтаФорма);
КонецПроцедуры

