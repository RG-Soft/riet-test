
&НаКлиенте
Процедура Привязать(Команда)
	
	Отказ = Ложь;
	
    ТекДанныеПоступление = Элементы.СписокПоступленийЭД.ТекущиеДанные;
	Если ТекДанныеПоступление = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не выделен документ ""Поступление товаров и услуг""!",,,,Отказ);
	КонецЕсли;	
	
	ТекДанныеСКП = Элементы.СписокСчетовКнигиПокупок.ТекущиеДанные;
	Если ТекДанныеСКП = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не выделен документ ""Счет книги покупок""!",,,,Отказ);
	КонецЕсли;
	
	Если Отказ Тогда 
		Возврат;
	КонецЕсли;
	
	ПривязатьНаСервере(Отказ, ТекДанныеСКП.СчетКнигиПокупок, ТекДанныеПоступление.ссылка);
	Если Не Отказ Тогда 
		ПоказатьОповещениеПользователя(,,"Изменен документ: 
		|Счет книги покупок " + ТекДанныеСКП.СчетКнигиПокупок + ".");
		Элементы.СписокПоступленийЭД.Обновить();
	КонецЕсли;
	
	Объект.СписокСчетовКнигиПокупок.Очистить();
	Объект.СписокСчетовФактур.Очистить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПривязатьНаСервере(Отказ, СчетКнигиПокупок, ПоступлениеСсылка)
	
	СКПОбъект = СчетКнигиПокупок.ПолучитьОбъект();

	Для Каждого Стр Из СКПОбъект.Суммы Цикл
		Если НЕ ЗначениеЗаполнено(Стр.ПоступлениеТоваровИУслуг) Тогда
			Стр.ПоступлениеТоваровИУслуг = ПоступлениеСсылка;
		КонецЕсли;	
	КонецЦикла;	
	СКПОбъект.ОбменДанными.Загрузка = Истина;
	Попытка
		СКПОбъект.Записать();
		Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не удалось записать: " + СчетКнигиПокупок + ",
		|" + ОписаниеОшибки(),,,,Отказ);
	КонецПопытки; 
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПоступленийЭДПриАктивизацииСтроки(Элемент)
	
	ТекДанные = Элемент.ТекущиеДанные;
	Если ТекДанные<>Неопределено Тогда 
		СтруктураМассивовСтруктур = ПолучитьМассивСтруктурСчетовКнигиПокупок(ТекДанные.Ссылка, ТекДанные.Контрагент);
		
		Объект.СписокСчетовКнигиПокупок.Очистить();
		Объект.СписокСчетовФактур.Очистить();
		
		МассивСКП = СтруктураМассивовСтруктур.МассивСКП;
		Для Каждого ЭлементМассива из МассивСКП Цикл 
			Стр = Объект.СписокСчетовКнигиПокупок.Добавить();
			ЗаполнитьЗначенияСвойств(Стр, ЭлементМассива); 
		КонецЦикла;
		
		МассивСФ = СтруктураМассивовСтруктур.МассивСФ;
		Для Каждого ЭлементМассива из МассивСФ Цикл 
			Стр = Объект.СписокСчетовФактур.Добавить();
			ЗаполнитьЗначенияСвойств(Стр, ЭлементМассива); 
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьМассивСтруктурСчетовКнигиПокупок(Поступление, Контрагент)
	
	СтруктураМассивовСтруктур = Новый Структура("МассивСКП,МассивСФ");
	
	МассивСКП = Новый Массив;
	МассивСФ = Новый Массив;
	       													
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ДокументСчетКнигиПокупок.Ссылка КАК СчетКнигиПокупок,
	               |	ДокументСчетКнигиПокупок.Ссылка.ДатаПроведения,
	               |	ДокументСчетКнигиПокупок.Ссылка.НалоговыйПериод,
	               |	ДокументСчетКнигиПокупок.Ссылка.Организация,
	               |	ДокументСчетКнигиПокупок.Ссылка.Контрагент,
	               |	ДокументСчетКнигиПокупок.Ссылка.НомерВходящегоДокумента,
	               |	ДокументСчетКнигиПокупок.Ссылка.ДатаВходящегоДокумента,
	               |	ДокументСчетКнигиПокупок.Ссылка.ВалютаДокумента,
	               |	ДокументСчетКнигиПокупок.СуммаСНДС,
	               |	ДокументСчетКнигиПокупок.СуммаСНДСРуб,
	               |	ДокументСчетКнигиПокупок.СуммаНДС,
	               |	ДокументСчетКнигиПокупок.СуммаНДСРуб,
	               |	ДокументСчетКнигиПокупок.Ссылка.НомерСФ,
	               |	ДокументСчетКнигиПокупок.Ссылка.ДатаСФ,
	               |	ДокументСчетКнигиПокупок.Ссылка.Корректировочный
	               |ИЗ
	               |	Документ.СчетКнигиПокупок.Суммы КАК ДокументСчетКнигиПокупок
	               |ГДЕ
	               |	ДокументСчетКнигиПокупок.ПоступлениеТоваровИУслуг = ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.пустаяСсылка)
	               |	И НЕ ДокументСчетКнигиПокупок.Ссылка.ПометкаУдаления
	               |	И ДокументСчетКнигиПокупок.Ссылка.Контрагент = &Контрагент
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СчетФактураПолученныйДокументыОснования.Ссылка КАК СчетФактураПолученный,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.Организация,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.Контрагент,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.Исправление,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.НомерИсправления,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.ДатаИсправления,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.СводныйКорректировочный,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.НомерИсходногоДокумента,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.ДатаИсходногоДокумента,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.УдалитьНомерИсправленияИсходногоДокумента КАК НомерИсправленияИсходногоДокумента,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.УдалитьДатаИсправленияИсходногоДокумента КАК ДатаИсправленияИсходногоДокумента,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.ИсправляемыйСчетФактура,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.ВалютаДокумента,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.Дата,
	               |	СчетФактураПолученныйДокументыОснования.Ссылка.КодВидаОперации
	               |ИЗ
	               |	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	               |ГДЕ
	               |	НЕ СчетФактураПолученныйДокументыОснования.Ссылка.ПометкаУдаления
	               |	И СчетФактураПолученныйДокументыОснования.ДокументОснование = &Поступление";
	
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("Поступление", Поступление);
	
	Результат = Запрос.ВыполнитьПакет();
		
	//СКП
	СтруктураСКП = Новый Структура("СчетКнигиПокупок,ДатаПроведения,НалоговыйПериод,Организация,Контрагент,НомерВходящегоДокумента,ДатаВходящегоДокумента,ВалютаДокумента,"
								+"СуммаСНДС,СуммаСНДСРуб,СуммаНДС,СуммаНДСРуб,НомерСФ,ДатаСФ,Корректировочный");

	ВыборкаСКП = Результат[0].Выбрать();
	Пока ВыборкаСКП.Следующий() Цикл
		
		Для Каждого ЭлементСтруктуры из СтруктураСКП Цикл 
			СтруктураСКП[ЭлементСтруктуры.Ключ] = ВыборкаСКП[ЭлементСтруктуры.Ключ];
		КонецЦикла;
		
		МассивСКП.Добавить(СтруктураСКП);
		
	КонецЦикла;
	
	//СФ
	СтруктураСФ = Новый Структура("СчетФактураПолученный,Организация,Контрагент,Исправление,НомерИсправления,ДатаИсправления,Корректировочный,НомерИсходногоДокумента,ДатаИсходногоДокумента,"+
								"НомерИсправленияИсходногоДокумента,ДатаИсправленияИсходногоДокумента,ИсправляемыйСчетФактура,ВалютаДокумента,Дата,КодВидаОперации");
	
	ВыборкаСФ = Результат[1].Выбрать();
	Пока ВыборкаСФ.Следующий() Цикл
		
		Для Каждого ЭлементСтруктуры из СтруктураСФ Цикл 
			СтруктураСФ[ЭлементСтруктуры.Ключ] = ВыборкаСФ[ЭлементСтруктуры.Ключ];
		КонецЦикла;
		
		МассивСФ.Добавить(СтруктураСФ);
		
	КонецЦикла;
	
	
	СтруктураМассивовСтруктур.МассивСКП = МассивСКП;
	СтруктураМассивовСтруктур.МассивСФ = МассивСФ;
	
	Возврат СтруктураМассивовСтруктур;
	   	
КонецФункции

&НаКлиенте
Процедура СписокСчетовКнигиПокупокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекДанные = Элемент.ТекущиеДанные;
	Если ЗначениеЗаполнено(ТекДанные.СчетКнигиПокупок) тогда
		ОткрытьЗначение(ТекДанные.СчетКнигиПокупок);
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура СписокСчетовФактурВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекДанные = Элемент.ТекущиеДанные;
	Если ЗначениеЗаполнено(ТекДанные.СчетФактураПолученный) тогда
		ОткрытьЗначение(ТекДанные.СчетФактураПолученный);
	КонецЕсли;

КонецПроцедуры
